[ -d ~/attune.home ] || mkdir ~/attune.home
SQLPASSWD=$(openssl rand -base64 32 | tr -dc _A-Z-a-z-0-9)

if ! grep -q "[disk_storage]" ~/attune.home/config.cfg
then

    cat <<EOF >> ~/attune.home/config.cfg
    
[disk_storage]
home_path = /home/{automationWorkerLinuxUser.user}/attune.home
archives_path = %(home_path)s/archives_contents
tmp_path = %(home_path)s/tmp
archives_unlocked_contents = %(home_path)s/archives_unlocked_contents
executions_path = %(home_path)s/historical_jobs
project_storage_path = %(home_path)s/projects

[alembic]
# path to migration scripts
script_location = /home/attune/python/lib/python2.7/site-packages/attune/alembic
sourceless = true
sqlalchemy.url = postgresql://{automationWorkerLinuxUser.user}:${SQLPASSWD}@localhost/attune

[user]
admin.pass = {automationWorkerLinuxUser.password}

[http]
key_file_path =
cert_file_path =
http_port = 8000

EOF

else
    echo "[disk_storage] is already written, skipping."
fi

# Set Postgresql Password to the New random password
psql <<< "alter role attune password '${SQLPASSWD}';"
echo "Attune PostgreSQL password has been reset"

echo "~/attune.home/config.cfg:"
cat ~/attune.home/config.cfg
