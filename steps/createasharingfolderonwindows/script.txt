# Define the folder path and share name
$ShareName = "share"
$FolderPath = "{automationWorkerWindowsBaseDirectory}\$ShareName"

# Ensure the File and Printer Sharing for Microsoft Networks service is enabled
Get-NetAdapter | ForEach-Object { 
    if (-not ($_ | Get-NetAdapterBinding -ComponentID ms_server).Enabled) {
        $_ | Enable-NetAdapterBinding -ComponentID ms_server
    }
}

Enable-NetFirewallRule -DisplayGroup "Network Discovery"

# Check if the folder exists
if (-not (Test-Path $folderPath)) {
    Write-Host "Folder does not exist: $folderPath"
    New-Item -Path $FolderPath -ItemType Directory
}

$AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule("Everyone", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$Acl = Get-Acl $FolderPath
$Acl.SetAccessRule($AccessRule)
Set-Acl -Path $FolderPath -AclObject $Acl
Get-Acl $FolderPath | Format-List

# Check if the share already exists
$shareExists = Get-SmbShare -Name $shareName -ErrorAction SilentlyContinue
if ($shareExists) {
    Write-Host "Share already exists: $shareName"
} else {
    # Create a new file share
    New-SmbShare -Name $shareName -Path $folderPath -FullAccess Everyone
    Write-Host "Share created: $shareName"
}

# Display current shares
Get-SmbShare